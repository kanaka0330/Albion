<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ€ ã‚ã‚‹ã³ãŠã‚“ãƒ“ãƒ³ã‚´ ğŸ€</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <style>
    body { font-family: 'Hiragino Kaku Gothic ProN', sans-serif; background: linear-gradient(135deg,#fff0f6,#e0f7fa); text-align: center; padding: 40px; color: #444; }
    h1 { font-size: 32px; color: #e67cb8; }
    #bingo-card, .mini-card { display: grid; grid-template-columns: repeat(5, 40px); gap: 6px; justify-content: center; margin: 10px auto; }
    .cell { width: 40px; height: 40px; line-height: 40px; border: 2px solid #f8a4c3; border-radius: 8px; background: #fff; font-size: 14px; }
    .marked { background: #fbd0e2; font-weight: bold; color: #e60073; }
    .highlight-line { background: #ffe066 !important; }
    .highlight-reach { background: #ffcccc !important; }
    button { margin: 10px; font-size: 16px; padding: 8px 16px; background: #f8a4c3; border: none; border-radius: 8px; color: white; cursor: pointer; }
    button:hover { background: #e67cb8; }
    input { padding: 8px; font-size: 16px; border: 1px solid #ccc; border-radius: 6px; margin-right: 8px; }
    #participants ul { list-style: none; padding: 0; }
    .participant { cursor: pointer; margin: 4px 0; }
  </style>
</head>
<body>
  <h1>ğŸ€ ã‚ã‚‹ã³ãŠã‚“ãƒ“ãƒ³ã‚´ ğŸ€</h1>

  <!-- åå‰å…¥åŠ› -->
  <div id="name-area">
    <input id="player-name" placeholder="ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" />
    <button onclick="registerPlayer()">å‚åŠ ã™ã‚‹</button>
  </div>

  <!-- ãƒ“ãƒ³ã‚´ã‚«ãƒ¼ãƒ‰ -->
  <div id="bingo-card"></div>

  <!-- æŠ½é¸ï¼†ãƒªã‚»ãƒƒãƒˆ -->
  <button onclick="drawNumber()">ç•ªå·ã‚’ã²ãğŸ²</button>
  <button onclick="resetGame()">ãƒªã‚»ãƒƒãƒˆğŸ§¹</button>
  <div id="drawn-numbers"></div>

  <!-- å‚åŠ è€…ä¸€è¦§ -->
  <div id="participants">
    <h3>ğŸŒ¸ å‚åŠ è€…ä¸€è¦§</h3>
    <ul id="participant-list"></ul>
  </div>

  <!-- è©³ç´°è¡¨ç¤º -->
  <div id="detail-card"></div>

<script>
  // Firebaseè¨­å®š
  const firebaseConfig = {
    apiKey: "AIzaSyDpiUUB8mB1eFBu2YejFVQlKtP1DF9cFKw",
    authDomain: "albion-0623.firebaseapp.com",
    databaseURL: "https://albion-0623-default-rtdb.firebaseio.com",
    projectId: "albion-0623",
    storageBucket: "albion-0623.appspot.com",
    messagingSenderId: "198257160394",
    appId: "1:198257160394:web:55c0a9b8f6e45ba0584433",
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const size = 5;
  const drawnNumbers = [];

  const cardEl = document.getElementById("bingo-card");
  const drawnDiv = document.getElementById("drawn-numbers");
  const nameInput = document.getElementById("player-name");
  const participantList = document.getElementById("participant-list");
  const detailCard = document.getElementById("detail-card");

  let myId = null;
  let myCard = null;

  // ã‚«ãƒ¼ãƒ‰ç”Ÿæˆ
  function generateCard() {
    const used = new Set();
    const card = [];
    for (let i = 0; i < size*size; i++) {
      let num;
      do { num = Math.floor(Math.random()*75)+1; } while (used.has(num));
      used.add(num);
      card[i] = num;
    }
    card[Math.floor(size*size/2)] = "FREE";
    return card;
  }

  function displayCard(card) {
    cardEl.innerHTML = "";
    card.forEach(n => {
      const c = document.createElement("div");
      c.className = "cell";
      c.textContent = n;
      if (n === "FREE") c.classList.add("marked");
      cardEl.appendChild(c);
    });
  }

  // å‚åŠ ç™»éŒ²
  function registerPlayer() {
    const name = nameInput.value.trim();
    if (!name) return alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼");
    myId = Date.now().toString();
    myCard = generateCard();
    displayCard(myCard);
    db.ref("participants/"+myId).set({ name, status:"å‚åŠ ä¸­", rank:null, card: myCard });
    nameInput.value = "";
  }

  // ç•ªå·æŠ½é¸
  function drawNumber() {
    db.ref("drawnNumbers").once("value").then(snap=>{
      const nums = snap.val()||[];
      if (nums.length>=75) return;
      let n; do { n=Math.floor(Math.random()*75)+1; } while(nums.includes(n));
      nums.push(n);
      db.ref("drawnNumbers").set(nums);
    });
  }

  // ãƒªã‚»ãƒƒãƒˆ
  function resetGame() {
    db.ref("drawnNumbers").set([]);
    db.ref("participants").set({});
  }

  // å‡ºãŸç•ªå·åæ˜ 
  db.ref("drawnNumbers").on("value", snap=>{
    const data = snap.val()||[];
    drawnNumbers.length=0; drawnNumbers.push(...data);
    drawnDiv.innerHTML = "<strong>å‡ºãŸç•ªå·ï¼š</strong>"+data.join("ãƒ»");
    updateMyStatus();
  });

  // ãƒªãƒ¼ãƒãƒ»ãƒ“ãƒ³ã‚´åˆ¤å®š
  function updateMyStatus(){
    if (!myId||!myCard) return;
    const lines = getLines(myCard);
    let reach=false, bingo=false;
    let bingoCount=0;
    lines.forEach(line=>{
      const marked=line.filter(v=>v==="FREE"||drawnNumbers.includes(v));
      if (marked.length===5){ bingo=true; bingoCount++; }
      else if (marked.length===4) reach=true;
    });
    let status="å‚åŠ ä¸­";
    if (bingo) status="ãƒ“ãƒ³ã‚´";
    else if (reach) status="ãƒªãƒ¼ãƒ";

    db.ref("participants/"+myId+"/status").set(status);

    if (bingo) {
      db.ref("participants").once("value").then(snap=>{
        const vals=snap.val()||{};
        const ranks=Object.values(vals).map(v=>v.rank).filter(r=>r);
        const nextRank=ranks.length+1;
        db.ref("participants/"+myId+"/rank").set(nextRank);
      });
    }
  }

  function getLines(card){
    const lines=[];
    for(let r=0;r<size;r++) lines.push(card.slice(r*size,r*size+size));
    for(let c=0;c<size;c++) lines.push(card.filter((_,i)=>i%size===c));
    lines.push(card.filter((_,i)=>i%6===0));
    lines.push(card.filter((_,i)=>i%4===0&&i>0&&i<24));
    return lines;
  }

  // å‚åŠ è€…ä¸€è¦§æ›´æ–°
  db.ref("participants").on("value", snap=>{
    const data=snap.val()||{};
    participantList.innerHTML="";
    Object.entries(data).forEach(([id,info])=>{
      const li=document.createElement("li");
      li.className="participant";
      li.textContent=`${info.name}ï¼š${info.status||"å‚åŠ ä¸­"} ${info.rank?`(${info.rank}ä½)`:""}`;
      li.onclick=()=>showDetailCard(info.card);
      participantList.appendChild(li);
    });
  });

  // è©³ç´°ã‚«ãƒ¼ãƒ‰è¡¨ç¤º
  function showDetailCard(card){
    if (!card) return;
    detailCard.innerHTML="";
    const grid=document.createElement("div");
    grid.className="mini-card";
    const lines=getLines(card);
    card.forEach((n,idx)=>{
      const cell=document.createElement("div");
      cell.className="cell";
      cell.textContent=n;
      if (n==="FREE"||drawnNumbers.includes(n)) cell.classList.add("marked");
      grid.appendChild(cell);
    });
    detailCard.appendChild(grid);

    // ãƒ©ã‚¤ãƒ³å¼·èª¿
    const cells=grid.querySelectorAll(".cell");
    lines.forEach(line=>{
      const marked=line.filter(v=>v==="FREE"||drawnNumbers.includes(v));
      if(marked.length===4){
        line.forEach(v=>{ let i=card.indexOf(v); cells[i].classList.add("highlight-reach"); });
      }
      if(marked.length===5){
        line.forEach(v=>{ let i=card.indexOf(v); cells[i].classList.add("highlight-line"); });
      }
    });
  }

</script>
</body>
</html>
